*filter
:INPUT {{ firewall_default_input_policy }} [0:0]
:FORWARD {{ firewall_default_forward_policy }} [0:0]
:OUTPUT {{ firewall_default_output_policy }} [0:0]

-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate INVALID -j DROP
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
{% if firewall_allow_icmp_v4 %}
-A INPUT -p icmp -j ACCEPT
{% endif %}
{% if firewall_allow_ssh_from_anywhere | bool %}
{% for port in firewall_effective_ssh_ports | default([ssh_port | int]) %}
-A INPUT -p tcp --dport {{ port }} -m conntrack --ctstate NEW -j ACCEPT
{% endfor %}
{% else %}
{% for cidr in firewall_allowed_ssh_cidrs if ':' not in cidr %}
{% for port in firewall_effective_ssh_ports | default([ssh_port | int]) %}
-A INPUT -p tcp -s {{ cidr }} --dport {{ port }} -m conntrack --ctstate NEW -j ACCEPT
{% endfor %}
{% endfor %}
{% endif %}
{% for port in firewall_allowed_tcp_ports %}
-A INPUT -p tcp --dport {{ port }} -m conntrack --ctstate NEW -j ACCEPT
{% endfor %}
{% for port in firewall_allowed_udp_ports %}
-A INPUT -p udp --dport {{ port }} -m conntrack --ctstate NEW -j ACCEPT
{% endfor %}
-A INPUT -j DROP

{% if firewall_forward_ipv4_enabled | bool %}
-A FORWARD -m conntrack --ctstate INVALID -j DROP
-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
{% if firewall_forward_ipv4_lan_cidr | length > 0 %}
-A FORWARD -i {{ firewall_forward_ipv4_lan_interface }} -o {{ firewall_forward_ipv4_wan_interface }} -s {{ firewall_forward_ipv4_lan_cidr }} -j ACCEPT
{% else %}
-A FORWARD -i {{ firewall_forward_ipv4_lan_interface }} -o {{ firewall_forward_ipv4_wan_interface }} -j ACCEPT
{% endif %}
{% endif %}

COMMIT

{% if firewall_nat_ipv4_enabled | bool %}
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

-A POSTROUTING -o {{ firewall_forward_ipv4_wan_interface }} -j MASQUERADE

COMMIT
{% endif %}
