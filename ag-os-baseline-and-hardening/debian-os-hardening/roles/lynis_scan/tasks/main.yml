---
- name: Ensure required packages for Lynis are present on managed host (online mode)
  ansible.builtin.apt:
    name:
      - git
      - ca-certificates
    state: present
    lock_timeout: "{{ apt_lock_timeout | default(600) }}"
  register: lynis_packages_install
  retries: "{{ apt_package_retries | default(6) }}"
  delay: "{{ apt_package_retry_delay | default(10) }}"
  until: lynis_packages_install is succeeded
  when: not (lynis_offline_bundle_from_control_node | bool)

- name: Ensure Lynis cache directory exists on control node (offline bundle mode)
  ansible.builtin.file:
    path: "{{ lynis_control_cache_dir }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  become: false
  run_once: true
  when: lynis_offline_bundle_from_control_node | bool

- name: Clone or update Lynis repository in control-node cache (offline bundle mode)
  ansible.builtin.git:
    repo: "{{ lynis_repo_url }}"
    dest: "{{ lynis_control_repo_dir }}"
    update: true
    version: "{{ lynis_repo_version }}"
  delegate_to: localhost
  become: false
  run_once: true
  when: lynis_offline_bundle_from_control_node | bool

- name: Resolve cached Lynis commit from control-node repository (offline bundle mode)
  ansible.builtin.command:
    cmd: "git -C {{ lynis_control_repo_dir }} rev-parse --short=12 HEAD"
  register: lynis_control_commit_cmd
  changed_when: false
  delegate_to: localhost
  become: false
  run_once: true
  when: lynis_offline_bundle_from_control_node | bool

- name: Set offline Lynis bundle metadata (offline bundle mode)
  ansible.builtin.set_fact:
    lynis_bundle_commit: "{{ lynis_control_commit_cmd.stdout | trim }}"
    lynis_bundle_filename: "lynis-{{ lynis_control_commit_cmd.stdout | trim }}.tar.gz"
    lynis_bundle_path: "{{ lynis_control_cache_dir }}/lynis-{{ lynis_control_commit_cmd.stdout | trim }}.tar.gz"
  delegate_to: localhost
  delegate_facts: true
  become: false
  run_once: true
  when: lynis_offline_bundle_from_control_node | bool

- name: Build commit-tagged Lynis bundle in control-node temp cache (offline bundle mode)
  ansible.builtin.command:
    cmd: >-
      tar -C {{ lynis_control_repo_dir }} --exclude=.git
      -czf {{ hostvars['localhost'].lynis_bundle_path }} .
  args:
    creates: "{{ hostvars['localhost'].lynis_bundle_path }}"
  delegate_to: localhost
  become: false
  run_once: true
  when: lynis_offline_bundle_from_control_node | bool

- name: Copy cached Lynis bundle to managed host (offline bundle mode)
  ansible.builtin.copy:
    src: "{{ hostvars['localhost'].lynis_bundle_path }}"
    dest: "/tmp/{{ hostvars['localhost'].lynis_bundle_filename }}"
    mode: "0644"
  when: lynis_offline_bundle_from_control_node | bool

- name: Ensure clean Lynis install path for bundle extraction (offline bundle mode)
  ansible.builtin.file:
    path: "{{ lynis_install_path }}"
    state: absent
  when: lynis_offline_bundle_from_control_node | bool

- name: Ensure Lynis install directory exists for bundle extraction (offline bundle mode)
  ansible.builtin.file:
    path: "{{ lynis_install_path }}"
    state: directory
    mode: "0755"
  when: lynis_offline_bundle_from_control_node | bool

- name: Extract Lynis bundle on managed host (offline bundle mode)
  ansible.builtin.unarchive:
    src: "/tmp/{{ hostvars['localhost'].lynis_bundle_filename }}"
    dest: "{{ lynis_install_path }}"
    remote_src: true
    mode: "0755"
  when: lynis_offline_bundle_from_control_node | bool

- name: Clone or update Lynis under /opt (online mode)
  ansible.builtin.git:
    repo: "{{ lynis_repo_url }}"
    dest: "{{ lynis_install_path }}"
    update: true
    version: "{{ lynis_repo_version }}"
  when: not (lynis_offline_bundle_from_control_node | bool)

- name: Check Lynis include directory exists
  ansible.builtin.stat:
    path: "{{ lynis_install_path }}/include"
  register: lynis_include_dir

- name: Assert Lynis installation is complete
  ansible.builtin.assert:
    that:
      - lynis_include_dir.stat.exists
      - lynis_include_dir.stat.isdir
    fail_msg: "Lynis installation looks incomplete at {{ lynis_install_path }}. Re-run the clone task."

- name: Run Lynis system audit
  ansible.builtin.command: "./lynis audit system {{ '--quick' if lynis_quick_mode else '' }}"
  args:
    chdir: "{{ lynis_install_path }}"
  environment:
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  register: lynis_run
  changed_when: false

- name: Ensure local artifact directory exists
  ansible.builtin.file:
    path: "{{ lynis_report_output_dir }}/{{ inventory_hostname }}"
    state: directory
    mode: "0755"
  delegate_to: localhost
  become: false

- name: Fetch Lynis report data
  ansible.builtin.fetch:
    src: /var/log/lynis-report.dat
    dest: "{{ lynis_report_output_dir }}/{{ inventory_hostname }}/lynis-report.dat"
    flat: true

- name: Fetch Lynis log
  ansible.builtin.fetch:
    src: /var/log/lynis.log
    dest: "{{ lynis_report_output_dir }}/{{ inventory_hostname }}/lynis.log"
    flat: true

- name: Read hardening index from Lynis report file
  ansible.builtin.command: "awk -F= '/^hardening_index=/{print $2}' /var/log/lynis-report.dat"
  register: lynis_index_cmd
  changed_when: false

- name: Extract hardening index
  ansible.builtin.set_fact:
    lynis_hardening_index: "{{ lynis_index_cmd.stdout | trim | default('N/A', true) }}"

- name: Print Lynis hardening index
  ansible.builtin.debug:
    msg: "Lynis hardening index for {{ inventory_hostname }}: {{ lynis_hardening_index }}"

- name: Show suggestion extraction hint
  ansible.builtin.debug:
    msg: >-
      Suggestions are in fetched file {{ lynis_report_output_dir }}/{{ inventory_hostname }}/lynis-report.dat
      (lines starting with 'suggestion[]='). Use them to prioritize next hardening tasks.
