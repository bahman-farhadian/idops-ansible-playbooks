---
- name: Start root-disk clone jobs for batch
  ansible.builtin.command:
    argv:
      - qemu-img
      - convert
      - -O
      - "{{ item.instance_disk_extension }}"
      - "{{ item.base_image_path }}"
      - "{{ item.instance_disk_path }}"
  loop: "{{ kvm_instance_batch }}"
  loop_control:
    label: "{{ item.instance_name }}"
  async: 3600
  poll: 0
  register: root_disk_clone_jobs
  changed_when: true

- name: Wait for root-disk clone jobs for batch
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ root_disk_clone_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.instance_name }}"
  register: root_disk_clone_status
  until: (root_disk_clone_status.finished | default(false)) | bool
  retries: 720
  delay: 5
  failed_when: (root_disk_clone_status.rc | default(0) | int) != 0
  when: item.ansible_job_id is defined

- name: Start root-disk resize jobs for batch
  ansible.builtin.command:
    argv:
      - qemu-img
      - resize
      - "{{ item.instance_disk_path }}"
      - "{{ item.root_disk_size_gb }}G"
  loop: "{{ kvm_instance_batch }}"
  loop_control:
    label: "{{ item.instance_name }}"
  async: 900
  poll: 0
  register: root_disk_resize_jobs
  changed_when: true

- name: Wait for root-disk resize jobs for batch
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ root_disk_resize_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.instance_name }}"
  register: root_disk_resize_status
  until: (root_disk_resize_status.finished | default(false)) | bool
  retries: 180
  delay: 5
  failed_when: (root_disk_resize_status.rc | default(0) | int) != 0
  when: item.ansible_job_id is defined
