---
# =========================================================================
# STAGE: image-cache
# =========================================================================
- name: Validate required cloud image list is available
  ansible.builtin.assert:
    that:
      - required_cloud_images is defined
      - required_cloud_images | length > 0
    fail_msg: "No required cloud images resolved from kvm_instance_definitions."

- name: Ensure image cache path exists when auto-create is enabled
  ansible.builtin.file:
    path: "{{ kvm_image_cache_path }}"
    state: directory
    mode: "0755"
  when:
    - kvm_run_mutation_phases | bool
    - kvm_auto_create_image_cache_path | default(true) | bool

- name: Check cached images and checksum state
  ansible.builtin.stat:
    path: "{{ item.cached_image_path }}"
    get_checksum: "{{ kvm_image_cache_verify_on_run | default(true) | bool }}"
    checksum_algorithm: sha256
  loop: "{{ required_cloud_images }}"
  loop_control:
    label: "{{ item.profile_id }}"
  register: image_cache_stats
  changed_when: false

- name: Report cached and valid image entries
  ansible.builtin.debug:
    msg: >-
      Cached image is valid: profile={{ item.item.profile_id }} path={{ item.item.cached_image_path }}
  loop: "{{ image_cache_stats.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - item.stat.exists | default(false)
    - >-
      not (kvm_image_cache_verify_on_run | default(true) | bool)
      or ((item.stat.checksum | default('') | lower) == (item.item.image_sha256 | lower))

- name: Fail on checksum mismatch when repair mode is disabled
  ansible.builtin.fail:
    msg: >-
      Cached image checksum mismatch for profile={{ item.item.profile_id }} file={{ item.item.cached_image_path }}.
      expected={{ item.item.image_sha256 }} got={{ item.stat.checksum | default('missing') }}.
      By default this fails safely. To repair automatically, set kvm_image_cache_repair_on_checksum_mismatch=true.
  loop: "{{ image_cache_stats.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - item.stat.exists | default(false)
    - kvm_image_cache_verify_on_run | default(true) | bool
    - (item.stat.checksum | default('') | lower) != (item.item.image_sha256 | lower)
    - not (kvm_image_cache_repair_on_checksum_mismatch | default(false) | bool)

- name: Remove checksum-mismatched cached image when repair mode is enabled
  ansible.builtin.file:
    path: "{{ item.item.cached_image_path }}"
    state: absent
  loop: "{{ image_cache_stats.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - kvm_run_mutation_phases | bool
    - item.stat.exists | default(false)
    - kvm_image_cache_verify_on_run | default(true) | bool
    - (item.stat.checksum | default('') | lower) != (item.item.image_sha256 | lower)
    - kvm_image_cache_repair_on_checksum_mismatch | default(false) | bool

- name: Initialize image download list
  ansible.builtin.set_fact:
    images_to_download: []

- name: Build image download list
  ansible.builtin.set_fact:
    images_to_download: "{{ (images_to_download | default([])) + [item.item] }}"
  loop: "{{ image_cache_stats.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - >-
      not (item.stat.exists | default(false))
      or (
        (kvm_image_cache_verify_on_run | default(true) | bool)
        and ((item.stat.checksum | default('') | lower) != (item.item.image_sha256 | lower))
        and (kvm_image_cache_repair_on_checksum_mismatch | default(false) | bool)
      )

- name: Explain planned downloads in check mode
  ansible.builtin.debug:
    msg: >-
      Check mode with mutation disabled: would download {{ images_to_download | length }} image(s):
      {{ images_to_download | map(attribute='profile_id') | join(', ') }}
  when:
    - not (kvm_run_mutation_phases | bool)
    - (images_to_download | default([])) | length > 0

- name: Download missing or repaired cloud images
  ansible.builtin.get_url:
    url: "{{ item.image_url }}"
    dest: "{{ item.cached_image_path }}"
    mode: "0644"
    checksum: "{{ ('sha256:' ~ item.image_sha256) if (item.image_sha256 | length > 0) else omit }}"
    force: false
  loop: "{{ images_to_download | default([]) }}"
  loop_control:
    label: "{{ item.profile_id }}"
  register: image_download_results
  when:
    - kvm_run_mutation_phases | bool
    - (images_to_download | default([])) | length > 0

- name: Verify cached image checksums after image-cache stage
  ansible.builtin.stat:
    path: "{{ item.cached_image_path }}"
    get_checksum: "{{ kvm_image_cache_verify_on_run | default(true) | bool }}"
    checksum_algorithm: sha256
  loop: "{{ required_cloud_images }}"
  loop_control:
    label: "{{ item.profile_id }}"
  register: image_cache_verify_results
  changed_when: false

- name: Fail when cached image verification fails
  ansible.builtin.fail:
    msg: >-
      Cached image verification failed for profile={{ item.item.profile_id }} path={{ item.item.cached_image_path }}.
      expected={{ item.item.image_sha256 }} got={{ item.stat.checksum | default('missing') }}.
  loop: "{{ image_cache_verify_results.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - >-
      not (item.stat.exists | default(false))
      or
      (
        (kvm_image_cache_verify_on_run | default(true) | bool)
        and ((item.stat.checksum | default('') | lower) != (item.item.image_sha256 | lower))
      )

- name: Image cache summary
  ansible.builtin.debug:
    msg: >-
      Image cache stage complete: managed_profiles={{ required_cloud_images | length }}
      downloaded={{ (images_to_download | default([])) | length }}.
