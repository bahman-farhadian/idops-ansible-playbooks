---
# =========================================================================
# STAGE: image-cache
# =========================================================================
- name: Validate resolved cloud image list is available
  ansible.builtin.assert:
    that:
      - required_cloud_images_resolved is defined
      - required_cloud_images_resolved | length > 0
    fail_msg: "No resolved cloud images available for image-cache stage."

- name: Ensure image cache path exists when auto-create is enabled
  ansible.builtin.file:
    path: "{{ kvm_image_cache_path }}"
    state: directory
    mode: "0755"
  when:
    - kvm_run_mutation_phases | bool
    - kvm_auto_create_image_cache_path | default(true) | bool

- name: Check versioned cached images and checksum state
  ansible.builtin.stat:
    path: "{{ item.cached_image_path }}"
    get_checksum: "{{ kvm_image_cache_verify_on_run | default(true) | bool }}"
    checksum_algorithm: "{{ item.image_checksum_algorithm }}"
  loop: "{{ required_cloud_images_resolved }}"
  loop_control:
    label: "{{ item.profile_id }}"
  register: image_cache_stats
  changed_when: false

- name: Report cached and valid versioned image entries
  ansible.builtin.debug:
    msg: >-
      Cached image is valid: profile={{ item.item.profile_id }} path={{ item.item.cached_image_path }}
  loop: "{{ image_cache_stats.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - item.stat.exists | default(false)
    - >-
      not (kvm_image_cache_verify_on_run | default(true) | bool)
      or ((item.stat.checksum | default('') | lower) == (item.item.official_checksum | lower))

- name: Fail on checksum mismatch when repair mode is disabled
  ansible.builtin.fail:
    msg: >-
      Cached image checksum mismatch for profile={{ item.item.profile_id }} file={{ item.item.cached_image_path }}.
      expected={{ item.item.official_checksum }} got={{ item.stat.checksum | default('missing') }}.
      By default this fails safely. To repair in place, set kvm_image_cache_repair_on_checksum_mismatch=true.
  loop: "{{ image_cache_stats.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - item.stat.exists | default(false)
    - kvm_image_cache_verify_on_run | default(true) | bool
    - (item.stat.checksum | default('') | lower) != (item.item.official_checksum | lower)
    - not (kvm_image_cache_repair_on_checksum_mismatch | default(false) | bool)

- name: Initialize image download list
  ansible.builtin.set_fact:
    images_to_download: []

- name: Build image download list
  ansible.builtin.set_fact:
    images_to_download: "{{ (images_to_download | default([])) + [item.item] }}"
  loop: "{{ image_cache_stats.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - >-
      not (item.stat.exists | default(false))
      or (
        (kvm_image_cache_verify_on_run | default(true) | bool)
        and ((item.stat.checksum | default('') | lower) != (item.item.official_checksum | lower))
        and (kvm_image_cache_repair_on_checksum_mismatch | default(false) | bool)
      )

- name: Explain planned downloads in check mode
  ansible.builtin.debug:
    msg: >-
      Check mode with mutation disabled: would download {{ images_to_download | length }} image(s):
      {{ images_to_download | map(attribute='profile_id') | join(', ') }}
  when:
    - not (kvm_run_mutation_phases | bool)
    - (images_to_download | default([])) | length > 0

- name: Download missing or repaired versioned cloud images
  ansible.builtin.get_url:
    url: "{{ item.image_url }}"
    dest: "{{ item.cached_image_path }}"
    mode: "0644"
    checksum: "{{ item.image_checksum_algorithm }}:{{ item.official_checksum }}"
    force: "{{ kvm_image_cache_repair_on_checksum_mismatch | default(false) | bool }}"
  loop: "{{ images_to_download | default([]) }}"
  loop_control:
    label: "{{ item.profile_id }}"
  register: image_download_results
  when:
    - kvm_run_mutation_phases | bool
    - (images_to_download | default([])) | length > 0

- name: Ensure alias path points to current versioned image
  ansible.builtin.file:
    src: "{{ item.cached_image_path }}"
    dest: "{{ item.cached_image_alias_path }}"
    state: link
    force: true
  loop: "{{ required_cloud_images_resolved }}"
  loop_control:
    label: "{{ item.profile_id }}"
  when: kvm_run_mutation_phases | bool

- name: Verify cached image checksums after image-cache stage
  ansible.builtin.stat:
    path: "{{ item.cached_image_path }}"
    get_checksum: "{{ kvm_image_cache_verify_on_run | default(true) | bool }}"
    checksum_algorithm: "{{ item.image_checksum_algorithm }}"
  loop: "{{ required_cloud_images_resolved }}"
  loop_control:
    label: "{{ item.profile_id }}"
  register: image_cache_verify_results
  changed_when: false

- name: Fail when cached image verification fails
  ansible.builtin.fail:
    msg: >-
      Cached image verification failed for profile={{ item.item.profile_id }} path={{ item.item.cached_image_path }}.
      expected={{ item.item.official_checksum }} got={{ item.stat.checksum | default('missing') }}.
  loop: "{{ image_cache_verify_results.results }}"
  loop_control:
    label: "{{ item.item.profile_id }}"
  when:
    - >-
      not (item.stat.exists | default(false))
      or
      (
        (kvm_image_cache_verify_on_run | default(true) | bool)
        and ((item.stat.checksum | default('') | lower) != (item.item.official_checksum | lower))
      )

- name: Image cache summary
  ansible.builtin.debug:
    msg: >-
      Image cache stage complete: managed_profiles={{ required_cloud_images_resolved | length }}
      downloaded={{ (images_to_download | default([])) | length }}.
      Versioned cache keeps historical images; old files are not deleted on latest updates.
