---
- name: Start additional-disk attach jobs for batch
  ansible.builtin.command:
    argv:
      - virsh
      - attach-disk
      - "{{ item.0.instance_name }}"
      - >-
        {{
          normalized_instance_disk_pool_path
          ~ '/'
          ~ item.0.instance_name
          ~ '-'
          ~ item.1.guest_device
          ~ '.'
          ~ (item.1.disk_extension | default(item.0.instance_disk_extension))
        }}
      - "{{ item.1.guest_device }}"
      - --targetbus
      - virtio
      - --subdriver
      - "{{ item.1.disk_extension | default(item.0.instance_disk_extension) }}"
      - --type
      - disk
      - --config
      - --persistent
  loop: "{{ kvm_extra_disk_attach_batch }}"
  loop_control:
    label: "{{ item.0.instance_name }}:{{ item.1.guest_device }}"
  async: 600
  poll: 0
  register: additional_disk_attach_jobs
  changed_when: true

- name: Wait for additional-disk attach jobs for batch
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ additional_disk_attach_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.0.instance_name }}:{{ item.item.1.guest_device }}"
  register: additional_disk_attach_status
  until: (additional_disk_attach_status.finished | default(false)) | bool
  retries: 120
  delay: 5
  failed_when: (additional_disk_attach_status.rc | default(0) | int) != 0
  when: item.ansible_job_id is defined
