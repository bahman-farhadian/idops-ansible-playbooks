- name: WARNING - Dry run mode
  ansible.builtin.debug:
    msg: |
      DRY RUN MODE - No instances will be deleted.
      To actually delete instances, run with: -e kvm_cleanup_confirmed=true
  when: not (kvm_cleanup_confirmed | bool)

- name: Check which instances exist
  ansible.builtin.command:
    cmd: virsh dominfo "{{ item.instance_name }}"
  loop: "{{ kvm_instance_definitions }}"
  loop_control:
    label: "{{ item.instance_name }}"
  register: instance_exists_check
  failed_when: false
  changed_when: false

- name: Build list of instances to delete
  ansible.builtin.set_fact:
    instances_to_delete: >-
      {{ kvm_instance_definitions | zip(instance_exists_check.results)
         | selectattr('1.rc', 'eq', 0)
         | map(attribute='0')
         | list }}

- name: Show instances that would be deleted (dry run)
  ansible.builtin.debug:
    msg: "Would delete: {{ instances_to_delete | map(attribute='instance_name') | join(', ') }}"
  when:
    - not (kvm_cleanup_confirmed | bool)
    - instances_to_delete | length > 0

- name: No instances to delete
  ansible.builtin.debug:
    msg: "No instances found to delete"
  when: instances_to_delete | length == 0

- name: Delete instances
  when:
    - kvm_cleanup_confirmed | bool
    - instances_to_delete | length > 0
  block:
    - name: Get instance states
      ansible.builtin.command:
        cmd: virsh domstate "{{ item.instance_name }}"
      loop: "{{ instances_to_delete }}"
      loop_control:
        label: "{{ item.instance_name }}"
      register: instance_states
      changed_when: false

    - name: Force stop running instances (async)
      ansible.builtin.command:
        cmd: virsh destroy "{{ item.item.instance_name }}"
      loop: "{{ instance_states.results }}"
      loop_control:
        label: "{{ item.item.instance_name }}"
      when: item.stdout == "running"
      async: 30
      poll: 0
      register: destroy_jobs
      failed_when: false
      changed_when: true

    - name: Wait for instances to stop
      ansible.builtin.async_status:
        jid: "{{ item.ansible_job_id }}"
      loop: "{{ destroy_jobs.results }}"
      loop_control:
        label: "{{ item.item.item.instance_name }}"
      register: destroy_results
      until: (destroy_results.finished | default(0) | int) == 1
      retries: 10
      delay: 3
      when: item.ansible_job_id is defined

    - name: Delete snapshots (async)
      ansible.builtin.shell: |
        for snap in $(virsh snapshot-list "{{ item.instance_name }}" --name 2>/dev/null); do
          virsh snapshot-delete "{{ item.instance_name }}" "$snap" 2>/dev/null || true
        done
      loop: "{{ instances_to_delete }}"
      loop_control:
        label: "{{ item.instance_name }}"
      async: 60
      poll: 0
      register: snapshot_delete_jobs
      changed_when: true

    - name: Wait for snapshot deletions
      ansible.builtin.async_status:
        jid: "{{ item.ansible_job_id }}"
      loop: "{{ snapshot_delete_jobs.results }}"
      loop_control:
        label: "{{ item.item.instance_name }}"
      register: snapshot_delete_results
      until: (snapshot_delete_results.finished | default(0) | int) == 1
      retries: 12
      delay: 5
      when: item.ansible_job_id is defined

    - name: Undefine instances and remove storage (async)
      ansible.builtin.command:
        cmd: virsh undefine "{{ item.instance_name }}" --remove-all-storage --snapshots-metadata
      loop: "{{ instances_to_delete }}"
      loop_control:
        label: "{{ item.instance_name }}"
      async: 120
      poll: 0
      register: undefine_jobs
      changed_when: true

    - name: Wait for instance deletions
      ansible.builtin.async_status:
        jid: "{{ item.ansible_job_id }}"
      loop: "{{ undefine_jobs.results }}"
      loop_control:
        label: "{{ item.item.instance_name }}"
      register: undefine_results
      until: (undefine_results.finished | default(0) | int) == 1
      retries: 24
      delay: 5
      when: item.ansible_job_id is defined

    - name: Cleanup complete
      ansible.builtin.debug:
        msg: |
          Deleted {{ instances_to_delete | length }} instances:
          {% for instance in instances_to_delete %}
            - {{ instance.instance_name }}
          {% endfor %}
