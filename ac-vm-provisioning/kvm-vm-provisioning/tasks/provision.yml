---
# =========================================================================
# PROVISION ORCHESTRATOR: cloud-image workflow
# Stages: full | preflight | image-cache | provision | runtime
# =========================================================================
- name: Validate provision stage value
  ansible.builtin.assert:
    that:
      - (kvm_provision_stage | default('full')) in ['full', 'preflight', 'image-cache', 'provision', 'runtime']
    fail_msg: "kvm_provision_stage must be one of: full, preflight, image-cache, provision, runtime."

- name: Validate instance definition list is provided
  ansible.builtin.assert:
    that:
      - kvm_instance_definitions is defined
      - kvm_instance_definitions | length > 0
    fail_msg: "Define at least one instance in vars/kvm-provisioning.yml under kvm_instance_definitions."

- name: Validate cloud image catalog is provided
  ansible.builtin.assert:
    that:
      - kvm_cloud_image_catalog is defined
      - kvm_cloud_image_catalog is mapping
      - kvm_cloud_image_catalog | length > 0
    fail_msg: "Define at least one image profile in vars/kvm-provisioning.yml under kvm_cloud_image_catalog."

- name: Fail when deprecated clone template variables are still used
  ansible.builtin.fail:
    msg: >-
      Deprecated clone-template variables were detected. This project now uses cloud-image provisioning.
      Remove kvm_template_catalog/template_instance_* settings and use kvm_cloud_image_catalog + image_profile_id.
  when: kvm_template_catalog is defined

- name: Determine whether mutation phases are allowed
  ansible.builtin.set_fact:
    kvm_run_mutation_phases: >-
      {{
        (not ansible_check_mode)
        or (kvm_execute_mutation_phases_in_check_mode | default(false) | bool)
      }}

- name: Explain check-mode mutation behavior
  ansible.builtin.debug:
    msg: >-
      Check mode is active and mutation phases are disabled
      (kvm_execute_mutation_phases_in_check_mode=false).
      Mutating stages are evaluated but will not create/download/start resources.
  when:
    - ansible_check_mode
    - not (kvm_run_mutation_phases | bool)

- name: Build stage execution flags
  ansible.builtin.set_fact:
    kvm_selected_stage: "{{ kvm_provision_stage | default('full') }}"
    kvm_run_stage_preflight: "{{ (kvm_provision_stage | default('full')) in ['full', 'preflight'] }}"
    kvm_run_stage_image_cache: "{{ (kvm_provision_stage | default('full')) in ['full', 'image-cache'] }}"
    kvm_run_stage_provision: "{{ (kvm_provision_stage | default('full')) in ['full', 'provision'] }}"
    kvm_run_stage_runtime: "{{ (kvm_provision_stage | default('full')) in ['full', 'runtime'] }}"

- name: Validate instance image profile references
  ansible.builtin.assert:
    that:
      - item.image_profile_id is defined
      - item.image_profile_id in kvm_cloud_image_catalog
    fail_msg: >-
      Instance {{ item.instance_name | default('unknown') }} references undefined image_profile_id
      '{{ item.image_profile_id | default('missing') }}'. Valid profile ids:
      {{ kvm_cloud_image_catalog.keys() | list | join(', ') }}.
  loop: "{{ kvm_instance_definitions }}"
  loop_control:
    label: "{{ item.instance_name | default('unknown') }}"

- name: Set per-instance defaults
  ansible.builtin.set_fact:
    instance_defaults:
      instance_disk_extension: "{{ kvm_default_instance_disk_extension }}"
      root_disk_size_gb: "{{ kvm_default_root_disk_size_gb }}"
      guest_network_interface: "{{ kvm_default_guest_network_interface }}"
      guest_network_prefix: "{{ kvm_default_guest_network_prefix }}"
      guest_network_gateway: "{{ kvm_default_guest_network_gateway }}"
      guest_dns_servers: "{{ kvm_default_guest_dns_servers }}"
      libvirt_network_name: "{{ kvm_default_libvirt_network_name }}"
      ssh_port: 22
      cloud_init_user: "{{ kvm_default_cloud_init_user }}"
      cloud_init_ssh_public_keys: "{{ kvm_default_cloud_init_ssh_public_keys }}"
      cloud_init_plain_password: "{{ kvm_default_cloud_init_plain_password }}"
      cloud_init_ssh_password_auth: "{{ kvm_default_cloud_init_ssh_password_auth }}"
      cloud_init_disable_root: "{{ kvm_default_cloud_init_disable_root }}"

- name: Build normalized instance definitions
  ansible.builtin.set_fact:
    normalized_instances: >-
      {{
        (normalized_instances | default([]))
        + [
          instance_defaults
          | combine(kvm_cloud_image_catalog[item.image_profile_id], recursive=True)
          | combine(item, recursive=True)
        ]
      }}
  loop: "{{ kvm_instance_definitions }}"
  loop_control:
    label: "{{ item.instance_name }}"

- name: Validate normalized instance fields
  ansible.builtin.assert:
    that:
      - item.instance_name is defined
      - item.instance_name | length > 0
      - item.instance_name is match('^[A-Za-z0-9][A-Za-z0-9-]{0,62}$')
      - item.image_profile_id is defined
      - item.image_url is defined
      - item.image_url | length > 0
      - item.image_filename is defined
      - item.image_filename | length > 0
      - item.image_checksum_algorithm is defined
      - item.image_checksum_algorithm in ['sha256', 'sha512']
      - item.virt_install_os_variant is defined
      - item.virt_install_os_variant | length > 0
      - item.instance_ipv4_address is defined
      - item.vcpu_count is defined
      - (item.vcpu_count | int) > 0
      - item.memory_mb is defined
      - (item.memory_mb | int) > 0
      - item.root_disk_size_gb is defined
      - (item.root_disk_size_gb | int) > 0
      - item.instance_disk_extension is match('^[A-Za-z0-9]+$')
      - item.libvirt_network_name is defined
      - item.libvirt_network_name | length > 0
      - item.cloud_init_user is defined
      - item.cloud_init_user | length > 0
      - item.cloud_init_ssh_public_keys is sequence
      - item.cloud_init_ssh_public_keys is not string
      - (item.cloud_init_plain_password | length > 0) or not (item.cloud_init_ssh_password_auth | bool)
      - >-
        (
          item.instance_mac_address is not defined
        )
        or
        (
          item.instance_mac_address is match('^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$')
        )
    fail_msg: >-
      Instance {{ item.instance_name | default('unknown') }} has invalid or missing required fields.
  loop: "{{ normalized_instances }}"
  loop_control:
    label: "{{ item.instance_name }}"

- name: Validate instance names are unique
  ansible.builtin.assert:
    that:
      - normalized_instances | map(attribute='instance_name') | list | length
        ==
        normalized_instances | map(attribute='instance_name') | list | unique | length
    fail_msg: "Instance names must be unique in kvm_instance_definitions."

- name: Build unique image profile list from requested instances
  ansible.builtin.set_fact:
    required_image_profiles: "{{ normalized_instances | map(attribute='image_profile_id') | unique | list }}"

- name: Build required cloud image metadata list
  ansible.builtin.set_fact:
    required_cloud_images: >-
      {{
        (required_cloud_images | default([]))
        + [
          {
            'profile_id': item,
            'image_url': kvm_cloud_image_catalog[item].image_url,
            'image_filename': kvm_cloud_image_catalog[item].image_filename,
            'image_checksum_manifest_url': (
              kvm_cloud_image_catalog[item].image_checksum_manifest_url
              | default(
                  (
                    kvm_cloud_image_catalog[item].image_url
                    | regex_replace('/[^/]+$', '')
                  ) ~ '/SHA512SUMS'
                )
            ),
            'image_checksum_algorithm': (
              kvm_cloud_image_catalog[item].image_checksum_algorithm
              | default('sha512')
            )
          }
        ]
      }}
  loop: "{{ required_image_profiles }}"
  loop_control:
    label: "{{ item }}"

- name: Build list of profiles using nocloud image artifacts
  ansible.builtin.set_fact:
    nocloud_image_profiles: >-
      {{
        required_cloud_images
        | selectattr('image_filename', 'search', 'nocloud')
        | map(attribute='profile_id')
        | list
      }}

- name: Fail fast when nocloud images are used for cloud-init workflow
  ansible.builtin.fail:
    msg: >-
      Profile(s) configured with nocloud images: {{
      nocloud_image_profiles | join(', ')
      }}.
      This project requires images that include cloud-init and are tested with
      Debian genericcloud artifacts.
      Switch image_url/image_filename to *-genericcloud-amd64.qcow2, then run:
      make image-cache && make cleanup-force-disks && make provision.
      Override only if intentional by setting kvm_allow_nocloud_images=true.
  when:
    - (nocloud_image_profiles | default([])) | length > 0
    - not (kvm_allow_nocloud_images | default(false) | bool)

- name: Resolve official image checksums and cache paths
  ansible.builtin.include_tasks: tasks/provision-resolve-image-metadata.yml
  when:
    - kvm_run_stage_image_cache | bool or kvm_run_stage_provision | bool

- name: Check which requested instances already exist
  ansible.builtin.command:
    cmd: virsh dominfo "{{ item.instance_name }}"
  loop: "{{ normalized_instances }}"
  loop_control:
    label: "{{ item.instance_name }}"
  register: instance_exists_check
  failed_when: false
  changed_when: false
  check_mode: false

- name: Build list of instances to create
  ansible.builtin.set_fact:
    instances_to_create: >-
      {{
        normalized_instances
        | zip(instance_exists_check.results)
        | selectattr('1.rc', 'ne', 0)
        | map(attribute='0')
        | list
      }}

- name: Build runtime target list
  ansible.builtin.set_fact:
    instance_runtime_targets: >-
      {{
        normalized_instances
        if (kvm_ensure_requested_instances_running | default(true) | bool)
        else instances_to_create
      }}

- name: Display stage and target summary
  ansible.builtin.debug:
    msg: >-
      Stage={{ kvm_selected_stage }} | requested={{ normalized_instances | length }} |
      create={{ instances_to_create | length }} |
      runtime_targets={{ instance_runtime_targets | length }} |
      mutation={{ kvm_run_mutation_phases | bool }}

- name: Run preflight stage
  ansible.builtin.include_tasks: tasks/provision-preflight.yml
  when: kvm_run_stage_preflight | bool

- name: Run image-cache stage
  ansible.builtin.include_tasks: tasks/provision-image-cache.yml
  when: kvm_run_stage_image_cache | bool

- name: Run instance provisioning stage
  ansible.builtin.include_tasks: tasks/provision-instances.yml
  when: kvm_run_stage_provision | bool

- name: Run runtime stage
  ansible.builtin.include_tasks: tasks/provision-runtime.yml
  when: kvm_run_stage_runtime | bool
