---
- name: Ensure supported OS family
  ansible.builtin.assert:
    that:
      - ansible_os_family == 'Debian'
    fail_msg: "This playbook currently supports Debian-family hypervisor hosts only."

- name: Install hypervisor packages
  ansible.builtin.apt:
    name: "{{ hypervisor_packages }}"
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Ensure libvirt service is enabled and running
  ansible.builtin.systemd:
    name: "{{ hypervisor_service_name }}"
    state: started
    enabled: true

- name: Ensure configured users are in libvirt group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: libvirt
    append: true
  loop: "{{ libvirt_users }}"
  when:
    - manage_libvirt_group_users | bool
    - libvirt_users | length > 0

- name: Hypervisor configuration summary
  ansible.builtin.debug:
    msg: >-
      Hypervisor configured | packages={{ hypervisor_packages | length }} |
      service={{ hypervisor_service_name }} |
      libvirt_users={{ libvirt_users | join(', ') if (libvirt_users | length > 0) else 'none' }}
